{% extends 'layout.html' %}
{% block body %}
<h2>Your Shipments</h2>

<div id="map-canvas"></div>


<script type="text/javascript"
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAXorWmQbNW4J7fGwSSpoZjjd9IgNvOGSQ">
</script>
<script type="text/javascript">
  var geocoder;
  var map;


  function initialize() {
  	geocoder = new google.maps.Geocoder();
  	var latlng = new google.maps.LatLng(37.7833, -122.4167);
    var mapOptions = {
      center: latlng,
      zoom: 8
    };
    map = new google.maps.Map(document.getElementById("map-canvas"),
        					  mapOptions);
  }

  function getLatLongs() {
    // receive json object from "/my_shipments" route
    var rows = {{ all_rows|safe }}
  	for (var i = 0; i < rows.length; i++) {
      var loc_id = rows[i]['id'];
      var location = rows[i]['placename'];
      getLatLong(loc_id, location);
  	}
  }

  function getLatLong(loc_id, location) {
    geocoder.geocode({ 'address': location }, function(results, status) {
    	if (status == google.maps.GeocoderStatus.OK) {
			var result = results[0].geometry.location;
			makeSaveLocRequest(loc_id, result);
		} else {
			alert("Geocode was not successful for the following reason: " + status);
		}
	});
  }

  function makeSaveLocRequest(loc_id, latlong) {
  	$.ajax({
  		url : "/save_location",
  		type: "POST",
  		data: {
  			id: loc_id,
  			latlong: latlong.toString()
  		}
      // If the save request failed.
  	}).fail(function(resp){
  		console.log("makeSaveLocRequest failed.");
      // If the save was successful, 
      // make another AJAX request to write this latlong to all 
      // location records in the same city.
  	}).done(function(resp){
  		console.log(" makeSaveLocRequest succeeded.");

      var data = resp.data;
      $.ajax({
        url: "/backfill_latlongs",
        type: "POST",
        data: {
          id: data.id,
          latlong: data.latlong.toString()
        }
      }).fail(function(resp) {
        console.log("backfill request failed.");
      }).done(function(resp) {
        console.log("backfill request succeeded.");
        console.log(resp);
      });
  	});
  }



  google.maps.event.addDomListener(window, 'load', initialize);
</script>
{% endblock %}