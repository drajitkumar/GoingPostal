{% extends 'layout.html' %}
{% block body %}
<h2>Your Shipments</h2>

<div id="map-canvas"></div>

<!--this is a browser key, need to edit allowed referrers-->
<script type="text/javascript"
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAXorWmQbNW4J7fGwSSpoZjjd9IgNvOGSQ">
</script>
<script type="text/javascript">

  var geocoder;
  var map;


  function initialize() {
  	geocoder = new google.maps.Geocoder();
    //TODO: Center on the browser's location
  	var latlng = new google.maps.LatLng(36.3955, -97.8783);
    var mapOptions = {
      center: latlng,
      zoom: 5
    };
    map = new google.maps.Map(document.getElementById("map-canvas"),
        					  mapOptions);

    getLatLongs();
  }

  function getLatLongs() {
    $.ajax({
      url: "/get_latlongs",
      type: "GET"
    }).fail(function(resp){
      console.log("getLatLongs failed.");
    }).done(function(resp){
    var rows = resp['resp'];
    // If there weren't any new locations to add, plot the paths
    if (rows.length === 0) {
      console.log("No rows in response.");
      map.data.loadGeoJson('/load_GeoJson');
    }
    // If there were new locations to geocode, geocode them
  	for (var i = 0; i < rows.length; i++) {
      var loc_id = rows[i]['id'];
      var location = rows[i]['placename'];
      getLatLong(loc_id, location);
  	  }
    });
  }

  function getLatLong(loc_id, location) {
    geocoder.geocode({ 'address': location }, function(results, status) {
    	if (status == google.maps.GeocoderStatus.OK) {
			var result = results[0].geometry.location;
      var latitude = result.k;
      var longitude = result.B;
      console.log("latitude is " + latitude + "longitude is " + longitude);
      console.log(typeof(latitude));
			makeSaveLocRequest(loc_id, latitude, longitude);
		} else {
			alert("Geocode was not successful for the following reason: " + status);
		}
	});
  }

  function makeSaveLocRequest(loc_id, latitude, longitude) {
  	$.ajax({
  		url : "/save_location",
  		type: "POST",
  		data: {
  			id: loc_id,
        latitude: latitude.toString(),
        longitude: longitude.toString()
  		}
    // If the save request failed.
  	}).fail(function(resp){
  		console.log("makeSaveLocRequest failed.");
    // If the save request was successful.
  	}).done(function(resp){
  		console.log(" makeSaveLocRequest succeeded.");
    //After the save location route, always do this
    }).always(function(resp) {
        console.log('hello');
        map.data.loadGeoJson('/load_GeoJson');
    });
  }



  google.maps.event.addDomListener(window, 'load', initialize);
</script>
{% endblock %}